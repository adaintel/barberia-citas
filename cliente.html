// Configuraci√≥n de Supabase (existente)
const supabaseUrl = 'https://azjlrbmgpczuintqyosm.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6amxyYm1ncGN6dWludHF5b3NtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NjM2MzgsImV4cCI6MjA3MDIzOTYzOH0.1ThXqiMuqRFhCTqsedG6NDFft_ng-QV2qaD8PpaU92M';

// Configuraci√≥n de Telegram (REEMPLAZA CON TUS DATOS REALES)
const TELEGRAM_BOT_TOKEN = "8473537897:AAE4DhBRqFSgkerepYMSA-meEBwn0pXjXag";
const TELEGRAM_CHAT_ID = "8330674980"; // ID de Antonio confirmado

// Inicializaci√≥n de Supabase
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// Funci√≥n mejorada para enviar notificaci√≥n a Telegram
async function enviarNotificacionTelegram(citaData) {
  const mensaje = `üíà *NUEVA CITA* üíà
  
üë§ *Cliente:* ${citaData.nombre}
üìû *Tel√©fono:* ${citaData.telefono}
üìÖ *Fecha:* ${new Date(citaData.fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
‚è∞ *Hora:* ${citaData.hora.substring(0, 5)}
‚úÇÔ∏è *Servicio:* ${citaData.servicio}
üßî *Barbero:* Antonio`;

  try {
    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: mensaje,
        parse_mode: 'Markdown'
      })
    });

    const data = await response.json();
    
    if (!data.ok) {
      console.error('Error de Telegram:', data.description);
      return false;
    }
    
    return true;
  } catch (error) {
    console.error('Error al enviar notificaci√≥n:', error);
    return false;
  }
}

// Funci√≥n modificada para guardar cita (existente con Telegram integrado)
async function guardarCita(citaData) {
  try {
    // 1. Guardar en Supabase
    const { data, error } = await supabase
      .from('citas')
      .insert([{
        ...citaData,
        estado: 'pendiente',
        creado_en: new Date().toISOString()
      }])
      .select();

    if (error) throw error;

    // 2. Enviar notificaci√≥n a Telegram
    const telegramEnviado = await enviarNotificacionTelegram(citaData);
    
    return {
      supabaseData: data,
      telegramEnviado: telegramEnviado
    };
  } catch (error) {
    console.error('Error al guardar cita:', error);
    throw error;
  }
}

// Manejo del formulario (existente con Telegram integrado)
document.addEventListener('DOMContentLoaded', () => {
  const citaForm = document.getElementById('citaForm');
  
  if (citaForm) {
    citaForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agendando...';

        const formData = {
          nombre: document.getElementById('nombre').value.trim(),
          telefono: document.getElementById('telefono').value.trim(),
          fecha: document.getElementById('fecha').value,
          hora: document.getElementById('hora').value,
          servicio: document.getElementById('servicio').value,
          barbero: document.getElementById('barbero').value || 'Antonio'
        };

        // Validaci√≥n b√°sica
        if (!formData.nombre || !formData.telefono) {
          throw new Error('Nombre y tel√©fono son requeridos');
        }

        const resultado = await guardarCita(formData);
        
        let mensaje = '‚úÖ Cita agendada correctamente';
        if (!resultado.telegramEnviado) {
          mensaje += ' (pero no se pudo enviar la notificaci√≥n al barbero)';
        }
        
        mostrarMensaje(mensaje, 'exito');
        citaForm.reset();
        inicializarFormulario();

      } catch (error) {
        console.error('Error:', error);
        mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });
  }
});

// Funciones auxiliares (existentes)
function mostrarMensaje(texto, tipo) {
  const mensajeDiv = document.getElementById('mensaje');
  if (mensajeDiv) {
    mensajeDiv.innerHTML = `<div class="mensaje-${tipo}">${texto}</div>`;
    mensajeDiv.style.display = 'block';
    setTimeout(() => mensajeDiv.style.display = 'none', 5000);
  }
}

function inicializarFormulario() {
  const fechaInput = document.getElementById('fecha');
  if (fechaInput) {
    const hoy = new Date();
    const manana = new Date(hoy);
    manana.setDate(hoy.getDate() + 1);
    fechaInput.min = manana.toISOString().split('T')[0];
    fechaInput.value = manana.toISOString().split('T')[0];
  }
}
